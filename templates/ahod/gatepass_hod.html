{% extends 'base.html' %}



{% block root %}
<style>
    /* Modern Gatepass Table Styles (from staff portal) */
    .od-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 16px;
        background: #fff;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        border-radius: 8px;
        overflow: visible;
        overflow-x: auto;
        box-sizing: border-box;
    }
    .od-table-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        background: #1976d2;
        color: #fff;
        font-weight: 600;
        font-size: 1.125rem;
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
    }
    .od-header, .od-row {
        display: grid;
        grid-template-columns: 6% 16% 14% 11% 11% 13% 9% 9% 11%;
        align-items: center;
        gap: 8px;
        padding: 12px 16px;
        border-bottom: 1px solid #e0e0e0;
        line-height: 1.4;
    }
    .od-header { 
        background: #f5f7fa;
        color: #2c3e50;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.85rem;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    .od-header > div { padding: 4px 8px; text-align: left; }
    .od-row { transition: background-color 0.15s ease; }
    .od-row:nth-child(even) { background: #f8fafc; }
    .od-row:hover { background: #f1f5f9; }
    .od-id { font-weight: 600; color: #1976d2; font-family: monospace; font-size: 0.9rem; }
    .od-row > div, .od-header > div { padding: 6px 8px; box-sizing: border-box; min-width: 0; }
    .od-header > div { white-space: nowrap; }
    .od-row > div:nth-child(2), .od-header > div:nth-child(2) { text-align: left; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .od-row > div:nth-child(3), .od-header > div:nth-child(3) { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .badge { display:inline-block; padding:4px 8px; border-radius:6px; font-weight:500; font-size:0.75rem; min-width:80px; text-align:center; }
    .badge-Approved { background:#ecfdf5; color:#047857; border:1px solid #a7f3d0; }
    .badge-Pending { background:#fffbeb; color:#b45309; border:1px solid #fcd34d; }
    .badge-Rejected { background:#fef2f2; color:#b91c1c; border:1px solid #fecaca; }
    .badge-success { background:#ecfdf5; color:#047857; border:1px solid #a7f3d0; }
    .badge-danger { background:#fef2f2; color:#b91c1c; border:1px solid #fecaca; }
    .badge-warning { background:#fffbeb; color:#b45309; border:1px solid #fcd34d; }
    .od-actions { display:flex; gap:4px; flex-wrap:nowrap; align-items:center; }
    .od-cell-action { min-width: 0; max-width: 100%; display:flex; align-items:center; justify-content:flex-start; overflow: hidden; padding: 4px !important; }
    .od-cell-action form { min-width: 0; max-width: 100%; width: 100%; display: flex; }
    .od-cell-action .od-actions { display:flex; gap:3px; align-items:center; flex-wrap:nowrap; min-width: 0; max-width: 100%; width: 100%; }
    .od-cell-action .od-actions .form-control { min-width: 0; max-width: 60px; width: 60px; flex: 0 0 60px; font-size: 0.7rem; padding: 0.2rem 0.3rem; height: auto; line-height: 1.2; }
    .od-cell-action .od-actions .btn { flex: 0 0 auto; white-space: nowrap; font-size: 0.7rem; padding: 0.2rem 0.4rem; height: auto; line-height: 1.2; }
    .od-cell-action span.text-success,
    .od-cell-action span.text-danger,
    .od-cell-action span.text-muted {
        max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: inline-block; font-size: 0.8rem;
    }
    .od-cell-action > .btn { margin-left: 8px; flex: 0 0 auto; }
    .od-title { font-weight:500; color:#334155; }
    .status-grid { display:grid; grid-template-columns:auto 1fr; gap:2px 6px; align-items:center; }
    .od-row > div[data-label="STATUS"] { min-width: 0; max-width: 100%; overflow: hidden; }
    .status-grid { min-width: 0; }
    .status-grid .badge { max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: inline-block; font-size: 0.7rem; padding: 3px 6px; min-width: 70px; }
    .status-label { color:#4b5563; font-size:0.75rem; font-weight:500; text-align:right; padding-right:4px; }
    @media (min-width: 769px) {
        .od-row > div { display:flex; align-items:center; }
        .od-row > div[data-label="STATUS"] { align-items:center; }
        .od-row > .od-cell-action { align-items:center; }
        .od-row > .od-cell-action .btn { display:inline-flex; align-items:center; justify-content:center; }
    }
    @media (max-width:768px) {
        .od-table { padding:8px; }
        .od-header, .od-row { grid-template-columns: 1fr; text-align:left; }
        .od-header div { display:none; }
        .od-row { border:1px solid #e0e0e0; margin-bottom:12px; border-radius:8px; padding:10px; background:#fff; }
        .od-row > div { display:block; padding:6px 0; }
        .od-row > div::before { content: attr(data-label); display:block; font-weight:600; color:#555; margin-bottom:6px; }
        .od-row > div[data-label="NAME"], .od-row > div[data-label="SUBJECT"], .od-row > div[data-label="STATUS"] { white-space:normal; }
        .od-row > div[data-label="VIEW"], .od-row > .od-cell-action { display:flex; gap:8px; flex-wrap:wrap; }
        .status-grid { display:flex; flex-direction:column; gap:6px; }
    }
</style>

<!-- Filter Section -->
<form method="get" class="form-inline mb-3">
    <label for="year" class="mr-2"><b>Filter by Year:</b></label>
    <select name="year" id="year" class="form-control mr-2">
        <option value="">All Years</option>
        <option value="1" {% if request.GET.year == '1' %}selected{% endif %}>1st Year</option>
        <option value="2" {% if request.GET.year == '2' %}selected{% endif %}>2nd Year</option>
        <option value="3" {% if request.GET.year == '3' %}selected{% endif %}>3rd Year</option>
        <option value="4" {% if request.GET.year == '4' %}selected{% endif %}>4th Year</option>
    </select>
    <button type="submit" class="btn btn-primary">Filter</button>
</form>



<!-- Mentees Gatepass Applications Table -->
<div class="card mt-4">
    <div class="od-table">
        <div class="od-table-header">
            <b>Mentees Gatepass Applications (AHOD)</b>
        </div>
        <div class="od-header">
            <div>#</div>
            <div>Student</div>
            <div>Subject</div>
            <div>From</div>
            <div>To</div>
            <div>SUBMITTED AT</div>
            <div>Status</div>
            <div>Action</div>
        </div>
        {% for g in mentee_gatepass_forms %}
            {% if not request.GET.year or g.user.year|stringformat:'s' == request.GET.year %}
            <div class="od-row">
                <div class="od-id">{{ forloop.counter }}</div>
                <div class="od-title">{{ g.user.name }}</div>
                <div>{{ g.sub }}</div>
                <div>{{ g.start|date:'Y-m-d H:i' }}</div>
                <div>{{ g.end|date:'Y-m-d H:i' }}</div>
                <div>{{ g.created|date:'Y-m-d H:i' }}</div>
                <div>
                    <div class="status-grid">
                        <div class="status-label">Mentor:</div>
                        <span class="badge badge-{{ g.Mstatus }}">{{ g.Mstatus }}</span>
                        <div class="status-label">Advisor:</div>
                        <span class="badge badge-{{ g.Astatus }}">{{ g.Astatus }}</span>
                        <div class="status-label">HOD:</div>
                        {% if g.Hstatus == 'Approved by AHOD' %}
                            <span class="badge badge-success">Approved by AHOD</span>
                        {% elif g.Hstatus == 'Rejected by AHOD' %}
                            <span class="badge badge-danger">Rejected by AHOD</span>
                        {% elif g.Hstatus == 'Approved' %}
                            <span class="badge badge-success">Approved</span>
                        {% elif g.Hstatus == 'Rejected' %}
                            <span class="badge badge-danger">Rejected</span>
                        {% else %}
                            <span class="badge badge-warning">Pending</span>
                        {% endif %}
                    </div>
                </div>
                <div>
                    {% if g.Mstatus == 'Pending' %}
                        <form method="post" action="{% url 'ahod_gatepass_hod' %}">
                            {% csrf_token %}
                            <input type="hidden" name="gatepass_id" value="{{ g.id }}">
                            <input type="hidden" name="role" value="mentor">
                            <div class="form-group mb-0">
                                <textarea name="reason" class="form-control" placeholder="Reason for Mentor action (required)" required>{{ g.ahod_reason }}</textarea>
                            </div>
                            <button name="sts" value="Approved" class="btn btn-success btn-sm mt-2">Approve</button>
                            <button name="sts" value="Rejected" class="btn btn-danger btn-sm mt-2">Reject</button>
                        </form>
                    {% elif g.Mstatus == 'Approved by AHOD' %}
                        <span class="badge badge-success">Approved by AHOD</span>
                    {% elif g.Mstatus == 'Rejected by AHOD' %}
                        <span class="badge badge-danger">Rejected by AHOD</span>
                    {% elif g.Mstatus == 'Approved' %}
                        <span class="badge badge-success">Approved</span>
                    {% elif g.Mstatus == 'Rejected' %}
                        <span class="badge badge-danger">Rejected</span>
                    {% else %}
                        {{ g.ahod_reason|default:'-' }}
                    {% endif %}
                </div>
            </div>
            {% endif %}
        {% empty %}
            <div class="od-row"><div style="grid-column:1/-1;text-align:center;padding:16px;">No mentee gatepass forms.</div></div>
        {% endfor %}
    </div>
</div>
<div class="card mb-4">
    <div class="od-table">
        <div class="od-table-header">
            <b>Department Students Gatepass Applications (HOD)</b>
        </div>
        <div class="od-header">
            <div>#</div>
            <div>Student</div>
            <div>Subject</div>
            <div>From</div>
            <div>To</div>
            <div>SUBMITTED AT</div>
            <div>Status</div>
            <div>Reason</div>
            <div>Action</div>
        </div>
        {% for g in gatepass_forms %}
            {% if not request.GET.year or g.user.year|stringformat:'s' == request.GET.year %}
            <div class="od-row">
                <div class="od-id">{{ forloop.counter }}</div>
                <div class="od-title">{{ g.user.name }}</div>
                <div>{{ g.sub }}</div>
                <div>{{ g.start|date:'Y-m-d H:i' }}</div>
                <div>{{ g.end|date:'Y-m-d H:i' }}</div>
                <div>{{ g.created|date:'Y-m-d H:i' }}</div>
                <div>
                    <div class="status-grid">
                        <div class="status-label">Mentor:</div>
                        <span class="badge badge-{{ g.Mstatus }}">{{ g.Mstatus }}</span>
                        <div class="status-label">Advisor:</div>
                        <span class="badge badge-{{ g.Astatus }}">{{ g.Astatus }}</span>
                        <div class="status-label">HOD:</div>
                        {% if g.Hstatus == 'Approved by AHOD' %}
                            <span class="badge badge-success">Approved by AHOD</span>
                            {% if g.ahod_reason %}<div class="text-muted small">Reason: {{ g.ahod_reason }}</div>{% endif %}
                        {% elif g.Hstatus == 'Rejected by AHOD' %}
                            <span class="badge badge-danger">Rejected by AHOD</span>
                            {% if g.ahod_reason %}<div class="text-muted small">Reason: {{ g.ahod_reason }}</div>{% endif %}
                        {% elif g.Hstatus == 'Approved' %}
                            <span class="badge badge-success">Approved</span>
                        {% elif g.Hstatus == 'Rejected' %}
                            <span class="badge badge-danger">Rejected</span>
                        {% else %}
                            <span class="badge badge-warning">Pending</span>
                        {% endif %}
                    </div>
                </div>
                <div>
                    {% if g.Hstatus == 'Pending' %}
                        <form method="post" action="{% url 'ahod_gatepass_hod' %}">
                            {% csrf_token %}
                            <input type="hidden" name="gatepass_id" value="{{ g.id }}">
                            <div class="form-group mb-0">
                                <textarea name="reason" class="form-control" placeholder="Reason for AHOD action (required)" required>{{ g.ahod_reason }}</textarea>
                            </div>
                            <button name="action" value="approve" class="btn btn-success btn-sm">Approve</button>
                            <button name="action" value="reject" class="btn btn-danger btn-sm">Reject</button>
                        </form>
                    {% elif g.Hstatus == 'Approved by AHOD' %}
                        <span class="badge badge-success">Approved by AHOD</span>
                        {% if g.ahod_reason %}<div class="text-muted small">{{ g.ahod_reason }}</div>{% endif %}
                    {% elif g.Hstatus == 'Rejected by AHOD' %}
                        <span class="badge badge-danger">Rejected by AHOD</span>
                        {% if g.ahod_reason %}<div class="text-muted small">{{ g.ahod_reason }}</div>{% endif %}
                    {% elif g.Hstatus == 'Approved' %}
                        <span class="badge badge-success">Approved</span>
                    {% elif g.Hstatus == 'Rejected' %}
                        <span class="badge badge-danger">Rejected</span>
                    {% else %}
                        {{ g.ahod_reason|default:'-' }}
                    {% endif %}
                </div>
            </div>
            {% endif %}
        {% empty %}
            <div class="od-row"><div style="grid-column:1/-1;text-align:center;padding:16px;">No gatepass forms.</div></div>
        {% endfor %}
    </div>
</div>
{% endblock %}